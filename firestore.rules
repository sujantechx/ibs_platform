rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function getAuthUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isApprovedUser() {
      return request.auth != null && getAuthUserDoc().data.status == 'approved';
    }

    function isAdmin() {
      return request.auth != null && getAuthUserDoc().data.role == 'admin';
    }

    // --- PUBLIC ACCESS FOR COURSE LIST ---
    match /courses/{courseId} {
      allow read;
    }

    // --- PUBLIC ACCESS FOR VAISHNAV PURAN LIST ---
    match /vaishnav_puran/{puranId} {
      allow read;
    }

    // --- USER PROFILE & DEVICES ---
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create: if request.auth != null && request.auth.uid == uid &&
                    request.resource.data.role == 'student' &&
                    request.resource.data.status == 'pending';
      // ✅ CORRECTED: A user can update their fcmToken and activeToken.
      // This is necessary for a single-device login to work.
      allow update: if request.auth != null && request.auth.uid == uid && (
        // Only allow these specific fields to be updated by the user
        ('fcmToken' in request.resource.data) ||
        ('activeToken' in request.resource.data)
      );

      // Admins have full access.
      allow read, write: if isAdmin();
      // An admin can write to ANY user document
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;

      // ✅ A user can only write to their own device document.
      match /devices/{deviceId} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if request.auth != null && request.auth.uid == uid && isApprovedUser();
        allow read, write: if isAdmin();
      }
    }
    // ✅ SOLUTION: Add a new rule for the 'notifications' collection
    match /notifications/{notificationId} {
      // Only admins can write (create, update, delete) notifications.
      allow write: if isAdmin();

      // Admins and the recipient of the notification can read it.
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.userId);
    }

    // --- SECURE NESTED CONTENT (READ-ONLY FOR USERS) ---
    match /courses/{courseId}/{document=**} {
      allow read, write: if isAdmin();
      allow read: if isApprovedUser() && getAuthUserDoc().data.courseId == courseId;
    }

    // --- PUBLIC NESTED CONTENT FOR VAISHNAV PURAN ---
    match /vaishnav_puran/{puranId}/{document=**} {
      allow read, write: if isAdmin();
      allow read; // Public read access
    }

    match /results/{documentId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create, update: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow delete: if isAdmin();
    }
  }
}
